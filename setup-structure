#!/bin/bash
set -e

echo "üèóÔ∏è  MicroTraderX: Setting up ConfigHub structure..."
echo ""

# Color codes for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Get or create unique prefix
if [ ! -x "bin/get-prefix" ]; then
  echo "‚ùå Error: bin/get-prefix not found or not executable"
  exit 1
fi

PREFIX=$(bin/get-prefix)
echo "üìõ Using prefix: $PREFIX"
echo ""

# Stage selection
STAGE=${1:-7}

echo -e "${BLUE}Stage $STAGE: Setting up structure...${NC}"
echo ""

case $STAGE in
  1)
    echo "Stage 1: Hello TraderX - Single service, single space"
    cub space create ${PREFIX}-traderx || true
    cub unit create --space ${PREFIX}-traderx reference-data k8s/reference-data.yaml || true
    echo -e "${GREEN}‚úì Created ${PREFIX}-traderx/reference-data${NC}"
    ;;

  2)
    echo "Stage 2: Three Environments"
    cub space create ${PREFIX}-traderx || true
    cub unit create --space ${PREFIX}-traderx reference-data k8s/reference-data.yaml || true

    for env in dev staging prod; do
      echo "  Creating ${PREFIX}-traderx-$env..."
      cub space create ${PREFIX}-traderx-$env || true
      # Create unit with upstream link (inheritance pattern)
      cub unit create reference-data \
        --space ${PREFIX}-traderx-$env \
        --upstream-space ${PREFIX}-traderx \
        --upstream-unit reference-data || true
    done
    echo -e "${GREEN}‚úì Created 3 environments (dev, staging, prod)${NC}"
    ;;

  3)
    echo "Stage 3: Three Regions with Links"

    # Create base space for shared config
    cub space create ${PREFIX}-traderx-base || true
    cub unit create --space ${PREFIX}-traderx-base reference-data k8s/reference-data.yaml || true
    cub unit create --space ${PREFIX}-traderx-base trade-service k8s/trade-service.yaml || true

    # Create infrastructure space for namespaces
    cub space create ${PREFIX}-traderx-infra || true
    cub unit create --space ${PREFIX}-traderx-infra ns-base k8s/namespace-base.yaml || true

    # Create regions with upstream relationships and links
    for region in us eu asia; do
      echo "  Creating ${PREFIX}-traderx-prod-$region with inheritance and links..."
      cub space create ${PREFIX}-traderx-prod-$region || true

      # Create app units (inherit from base)
      cub unit create reference-data \
        --space ${PREFIX}-traderx-prod-$region \
        --upstream-space ${PREFIX}-traderx-base \
        --upstream-unit reference-data || true

      cub unit create trade-service \
        --space ${PREFIX}-traderx-prod-$region \
        --upstream-space ${PREFIX}-traderx-base \
        --upstream-unit trade-service || true

      # Create namespace unit for this region
      cub unit create ns-$region \
        --space ${PREFIX}-traderx-infra \
        --upstream-space ${PREFIX}-traderx-infra \
        --upstream-unit ns-base || true

      # Customize namespace name
      cub run set-string-path \
        --resource-type v1/Namespace \
        --path metadata.name \
        --attribute-value ${PREFIX}-traderx-prod-$region \
        --unit ns-$region \
        --space ${PREFIX}-traderx-infra \
        --quiet || true

      # Link app units to namespace (resolves confighubplaceholder)
      # Syntax: cub link create --space <space> --json <link-name> <from-unit> <to-unit> [<to-space>]
      cub link create --space ${PREFIX}-traderx-prod-$region \
        --json app-to-ns-ref reference-data ns-$region ${PREFIX}-traderx-infra || true

      cub link create --space ${PREFIX}-traderx-prod-$region \
        --json app-to-ns-trade trade-service ns-$region ${PREFIX}-traderx-infra || true

      # Link trade-service to reference-data (service dependency - same space)
      cub link create --space ${PREFIX}-traderx-prod-$region \
        --json trade-to-ref trade-service reference-data || true
    done

    # Regional customizations based on trading volume
    echo "  Customizing regional scale..."
    echo '{"spec":{"replicas":3}}' | cub unit update trade-service --space ${PREFIX}-traderx-prod-us \
      --patch --from-stdin || true  # NYSE hours
    echo '{"spec":{"replicas":5}}' | cub unit update trade-service --space ${PREFIX}-traderx-prod-eu \
      --patch --from-stdin || true  # Peak trading
    echo '{"spec":{"replicas":2}}' | cub unit update trade-service --space ${PREFIX}-traderx-prod-asia \
      --patch --from-stdin || true  # Overnight

    echo -e "${GREEN}‚úì Created base + 3 regions with links${NC}"
    echo ""
    echo "Links introduced (brief intro - full details in Stage 8):"
    echo "  ‚Ä¢ App ‚Üí Namespace (resolves confighubplaceholder)"
    echo "  ‚Ä¢ trade-service ‚Üí reference-data (service dependency)"
    echo ""
    echo "Structure:"
    echo "  ${PREFIX}-traderx-base/        (shared config)"
    echo "  ${PREFIX}-traderx-infra/       (namespace units)"
    echo "  ${PREFIX}-traderx-prod-us/     (3 replicas - NYSE)"
    echo "  ${PREFIX}-traderx-prod-eu/     (5 replicas - Peak)"
    echo "  ${PREFIX}-traderx-prod-asia/   (2 replicas - Overnight)"
    ;;

  4)
    echo "Stage 4: Push-Upgrade with Inheritance"

    # Create base space
    cub space create ${PREFIX}-traderx-base || true
    cub unit create --space ${PREFIX}-traderx-base reference-data k8s/reference-data.yaml || true
    cub unit create --space ${PREFIX}-traderx-base trade-service k8s/trade-service.yaml || true

    # Create regions with upstream links (canonical pattern)
    for region in us eu asia; do
      echo "  Creating ${PREFIX}-traderx-prod-$region with inheritance..."
      cub space create ${PREFIX}-traderx-prod-$region || true

      # Use space/slug notation (not unit IDs) - canonical pattern from acmetodo
      cub unit create reference-data \
        --space ${PREFIX}-traderx-prod-$region \
        --upstream-space ${PREFIX}-traderx-base \
        --upstream-unit reference-data || true

      cub unit create trade-service \
        --space ${PREFIX}-traderx-prod-$region \
        --upstream-space ${PREFIX}-traderx-base \
        --upstream-unit trade-service || true
    done

    # Regional customizations (preserved during upgrade!)
    echo "  Customizing regional scale (will be preserved)..."
    cub unit update trade-service --space ${PREFIX}-traderx-prod-us \
      --patch '{"spec":{"replicas":3}}' || true
    cub unit update trade-service --space ${PREFIX}-traderx-prod-eu \
      --patch '{"spec":{"replicas":5}}' || true
    cub unit update trade-service --space ${PREFIX}-traderx-prod-asia \
      --patch '{"spec":{"replicas":2}}' || true

    echo -e "${GREEN}‚úì Created base + regions with inheritance${NC}"
    echo "  Regional scale will be preserved during upgrades!"
    ;;

  5)
    echo "Stage 5: Find and Fix - Bulk Operations"
    # Reuse Stage 4 structure
    ./setup-structure 4

    echo ""
    echo -e "${YELLOW}Find and Fix Examples:${NC}"
    echo "  Find high-replica services in EU:"
    echo "    cub unit list --space '${PREFIX}-traderx-prod-eu' --where \"Data CONTAINS 'replicas: 5'\""
    echo ""
    echo "  Scale down after market close:"
    echo "    cub run set-replicas --replicas 2 --space ${PREFIX}-traderx-prod-eu --where \"Data CONTAINS 'replicas: 5'\""
    ;;

  6)
    echo "Stage 6: Atomic Updates with Changesets"
    ./setup-structure 4

    echo ""
    echo -e "${YELLOW}Changeset Example:${NC}"
    echo "  Create changeset:"
    echo "    cub changeset create market-data-v2"
    echo "  Add related changes:"
    echo "    cub unit update reference-data --space ${PREFIX}-traderx-prod-us --patch '{\"image\":\"v2\"}'"
    echo "    cub unit update trade-service --space ${PREFIX}-traderx-prod-us --patch '{\"image\":\"v2\"}'"
    echo "  Apply atomically:"
    echo "    cub changeset apply market-data-v2"
    ;;

  7)
    echo "Stage 7: Complete System with All Features"

    # Create base
    cub space create ${PREFIX}-traderx-base || true
    cub unit create --space ${PREFIX}-traderx-base reference-data k8s/reference-data.yaml || true
    cub unit create --space ${PREFIX}-traderx-base trade-service k8s/trade-service.yaml || true

    # Create dev/staging (canonical pattern)
    for env in dev staging; do
      echo "  Creating ${PREFIX}-traderx-$env..."
      cub space create ${PREFIX}-traderx-$env || true

      # Use space/slug notation (not unit IDs) - canonical pattern from acmetodo
      cub unit create reference-data \
        --space ${PREFIX}-traderx-$env \
        --upstream-space ${PREFIX}-traderx-base \
        --upstream-unit reference-data || true

      cub unit create trade-service \
        --space ${PREFIX}-traderx-$env \
        --upstream-space ${PREFIX}-traderx-base \
        --upstream-unit trade-service || true
    done

    # Create regions (canonical pattern)
    for region in us eu asia; do
      echo "  Creating ${PREFIX}-traderx-prod-$region..."
      cub space create ${PREFIX}-traderx-prod-$region || true

      # Use space/slug notation (not unit IDs) - canonical pattern from acmetodo
      cub unit create reference-data \
        --space ${PREFIX}-traderx-prod-$region \
        --upstream-space ${PREFIX}-traderx-base \
        --upstream-unit reference-data || true

      cub unit create trade-service \
        --space ${PREFIX}-traderx-prod-$region \
        --upstream-space ${PREFIX}-traderx-base \
        --upstream-unit trade-service || true
    done

    # Regional customizations
    echo "  Customizing regional scale..."
    cub unit update trade-service --space ${PREFIX}-traderx-prod-us \
      --patch '{"spec":{"replicas":3}}' || true
    cub unit update trade-service --space ${PREFIX}-traderx-prod-eu \
      --patch '{"spec":{"replicas":5}}' || true
    cub unit update trade-service --space ${PREFIX}-traderx-prod-asia \
      --patch '{"spec":{"replicas":2}}' || true

    echo -e "${GREEN}‚úì Complete system created!${NC}"
    echo ""
    echo "Structure:"
    echo "  ${PREFIX}-traderx-base/          (shared configs)"
    echo "  ${PREFIX}-traderx-dev/           (development)"
    echo "  ${PREFIX}-traderx-staging/       (staging)"
    echo "  ${PREFIX}-traderx-prod-us/       (3 replicas - NYSE)"
    echo "  ${PREFIX}-traderx-prod-eu/       (5 replicas - Peak)"
    echo "  ${PREFIX}-traderx-prod-asia/     (2 replicas - Overnight)"
    ;;

  *)
    echo "Usage: $0 [stage]"
    echo "Stages: 1-7 (default: 7)"
    exit 1
    ;;
esac

echo ""
echo -e "${BLUE}Next: Run './deploy $STAGE' to deploy to Kubernetes${NC}"
